#include <ESP8266WiFi.h>
#include <espnow.h>
#include <SoftwareSerial.h> 

// ====================================================================
//                          1. HARDWARE CONFIGURATION
// ====================================================================

// --- 1.1 HUB MAC ADDRESS (For Status Reply) ---
// ESP32-S3 Hub MAC Address: 30:ed:a0:be:4f:8c
uint8_t HUB_MAC_ADDRESS[] = {0x30, 0xED, 0xA0, 0xBE, 0x4F, 0x8C}; 

// --- 1.2 SSC-32U Communication ---
// Example pins: D6 (RX), D7 (TX). Adjust based on your NodeMCU wiring.
SoftwareSerial sscSerial(D6, D7); 
const long SSC_BAUD_RATE = 115200;

// --- 1.3 6-SERVO SSC-32U CHANNEL MAPPING ---
const int BASE_CH = 0; 
const int SHOULDER_CH = 1;
const int ELBOW_CH = 2;
const int WRIST_YAW_CH = 3; 
const int WRIST_PITCH_CH = 4; 
const int GRIPPER_CH = 5; 


// ====================================================================
//                          2. ESP-NOW STRUCTURES (6 SERVOS - SYNCHRONIZED)
// ====================================================================

// --- 2.1 Communication Structures (MUST MATCH ESP32-S3 HUB) ---
typedef struct ControlMessage {
    int motor_pulses[6]; 
    int recordCommand;
} ControlMessage;
ControlMessage receivedData; 

typedef struct StatusMessage {
    int status_code;
    int current_positions[6];
    int recording_steps;    
} StatusMessage;
StatusMessage outputStatus; 

// Function to send command to SSC-32U
void sendServoCommands(int pulseBase, int pulseShoulder, int pulseElbow, int pulseWristYaw, int pulseWristPitch, int pulseGripper, int transitionTime) {
    char command[120];

    // Format the command string for SSC-32U (Channels 0, 1, 2, 3, 4, 5)
    sprintf(command, "#%dP%d #%dP%d #%dP%d #%dP%d #%dP%d #%dP%d T%d\r", 
        BASE_CH, pulseBase, 
        SHOULDER_CH, pulseShoulder, 
        ELBOW_CH, pulseElbow, 
        WRIST_YAW_CH, pulseWristYaw,
        WRIST_PITCH_CH, pulseWristPitch, 
        GRIPPER_CH, pulseGripper, 
        transitionTime);

    sscSerial.print(command);
}

// Function to set all 6 servos to the 1500us center pulse
void centerAllServos() {
    sscSerial.print("#0P1500 #1P1500 #2P1500 #3P1500 #4P1500 #5P1500 T1000\r");
    Serial.println("6 Servos centered (1500us) via SSC-32U.");
    delay(1000); 
}


// ====================================================================
//                          3. ESP-NOW CALLBACKS
// ====================================================================

void OnDataRecv(uint8_t * mac, uint8_t *incomingDataPtr, uint8_t len) {
    memcpy(&receivedData, incomingDataPtr, sizeof(receivedData));

    // 1. Execute any momentary commands
    if (receivedData.recordCommand != 0) {
        Serial.printf("COMMAND RECEIVED: %d\n", receivedData.recordCommand);
    }
    
    // 2. Apply all 6 motor pulses directly via the SSC-32U
    sendServoCommands(
        receivedData.motor_pulses[0], 
        receivedData.motor_pulses[1], 
        receivedData.motor_pulses[2], 
        receivedData.motor_pulses[3], 
        receivedData.motor_pulses[4], 
        receivedData.motor_pulses[5], 
        50 // Transition Time 50ms 
    );

    // 3. Update status data
    for (int i = 0; i < 6; i++) {
        outputStatus.current_positions[i] = receivedData.motor_pulses[i];
    }
    
    // 4. Send the status back to the ESP32-S3 Hub 
    esp_now_send(HUB_MAC_ADDRESS, (uint8_t *) &outputStatus, sizeof(outputStatus));
}


// ====================================================================
//                          4. SETUP AND LOOP
// ====================================================================

void setup() {
    Serial.begin(115200);
    delay(1000); 

    Serial.print("NodeMCU MAC Address: ");
    Serial.println(WiFi.macAddress());
    
    // --- 4.1 Initialize SSC-32U SoftwareSerial ---
    sscSerial.begin(SSC_BAUD_RATE);
    
    // --- 4.2 Initialize ESP-NOW ---
    WiFi.mode(WIFI_STA);
    if (esp_now_init() != 0) {
        Serial.println("Error initializing ESP-NOW");
        outputStatus.status_code = 1; 
        return;
    }
    
    // Register the receive callback function
    esp_now_set_self_role(ESP_NOW_ROLE_COMBO);
    esp_now_register_recv_cb(OnDataRecv);

    // --- 4.3 Center Servos (Safety Check) ---
    centerAllServos();
    
    // --- 4.4 Register Hub Peer (for Status Return) ---
    esp_now_add_peer(HUB_MAC_ADDRESS, ESP_NOW_ROLE_COMBO, 0, NULL, 0);

    Serial.println("Robot Controller Ready.");
    outputStatus.status_code = 0; 
}

void loop() {
    delay(10); 
}
